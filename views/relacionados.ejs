<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Relacionados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Consulta de Relacionados</h5>
            </div>
            <div class="card-body">
                <div class="controls-container">
                    <div class="controls-left">
                        <input type="date" id="fechaConsulta" class="form-control">
                        <button id="btnConsultar" class="btn btn-consultar">
                            <i class="fas fa-search me-2"></i>Consultar
                        </button>
                    </div>
                    <h3 class="mode-title">Relacionados</h3>
                </div>
                <div class="table-container">
                    <div class="table-responsive">
                        <table class="table table-hover" id="tablaRelacionados">
                            <thead>
                                <tr>
                                    <th>PROCESADA</th>
                                    <th>MENSAJE</th>
                                    <th>FILEPROCEFECHA</th>
                                    <th>DE3</th>
                                    <th>DE4</th>
                                    <th>DE6</th>
                                    <th>DE24</th>
                                    <th>DE25</th>
                                    <th>DE38</th>
                                    <th>DE43</th>
                                    <th>DE49</th>
                                    <th>DE51</th>
                                    <th>DE63</th>
                                    <th>AUTOVISATID</th>
                                    <th>CTA_INFI</th>
                                    <th>AUTOCODI</th>
                                    <th>AUTOFECHA</th>
                                    <th>CONSUFECHA</th>
                                    <th>CONSUMIPOR</th>
                                    <th>AUTOIMPOR</th>
                                    <th>ORIGEN_</th>
                                    <th>DIFERENCIA</th>
                                    <th>A_MAMBU</th>
                                    <th>RELA_OK</th>
                                    <th>ONL_OK</th>
                                    <th>STATUSMAMBU</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Página cargada');
            const fechaHoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaConsulta').value = fechaHoy;
            console.log('Fecha inicial:', fechaHoy);

            document.getElementById('btnConsultar').addEventListener('click', async function() {
                const fecha = document.getElementById('fechaConsulta').value;
                console.log('Consultando fecha:', fecha);
                
                try {
                    console.log('Iniciando fetch a /api/relacionados/consulta');
                    const response = await fetch('/api/relacionados/consulta', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ fecha })
                    });

                    console.log('Respuesta recibida, status:', response.status);
                    if (!response.ok) {
                        throw new Error(`Error en la consulta: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Datos recibidos:', data);
                    console.log('Número total de registros:', data.length);
                    
                    const tbody = document.querySelector('#tablaRelacionados tbody');
                    tbody.innerHTML = '';

                    data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${row.PROCESADA || ''}</td>
                            <td>${row.MENSAJE || ''}</td>
                            <td>${row.FILEPROCEFECHA || ''}</td>
                            <td>${row.DE3 || ''}</td>
                            <td>${row.DE4 || ''}</td>
                            <td>${row.DE6 || ''}</td>
                            <td>${row.DE24 || ''}</td>
                            <td>${row.DE25 || ''}</td>
                            <td>${row.DE38 || ''}</td>
                            <td>${row.DE43 || ''}</td>
                            <td>${row.DE49 || ''}</td>
                            <td>${row.DE51 || ''}</td>
                            <td>${row.DE63 || ''}</td>
                            <td>${row.AUTOVISATID || ''}</td>
                            <td>${row.CTA_INFI || ''}</td>
                            <td>${row.AUTOCODI || ''}</td>
                            <td>${row.AUTOFECHA || ''}</td>
                            <td>${row.CONSUFECHA || ''}</td>
                            <td>${row.CONSUMIPOR || ''}</td>
                            <td>${row.AUTOIMPOR || ''}</td>
                            <td>${row.ORIGEN_ || ''}</td>
                            <td>${row.DIFERENCIA || ''}</td>
                            <td>${row.A_MAMBU || ''}</td>
                            <td>${row.RELA_OK || ''}</td>
                            <td>${row.ONL_OK || ''}</td>
                            <td>${row.STATUSMAMBU || ''}</td>
                        `;
                        tbody.appendChild(tr);
                    });

                } catch (error) {
                    console.error('Error en la consulta:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message || 'Error al consultar los datos'
                    });
                }
            });
        });
    </script>
</body>
</html>